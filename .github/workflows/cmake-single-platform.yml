name: CMake and Codecov

   on:
     push:
       branches: [ "master" ]
     pull_request:
       branches: [ "master" ]

   env:
     BUILD_TYPE: Debug

   jobs:
     build:
       runs-on: ubuntu-latest

       steps:
       - uses: actions/checkout@v4

       - name: Install gcovr
         run: sudo apt-get install -y gcovr

       - name: Configure CMake
         run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

       - name: Build
         run: cmake --build build --config ${{env.BUILD_TYPE}}

       - name: Test
         working-directory: build
         run: ctest -C ${{env.BUILD_TYPE}}

       - name: Generate coverage report
         run: gcovr -r . build --xml -o coverage.xml

       - name: Upload coverage to Codecov
         uses: codecov/codecov-action@v3
         with:
           token: ${{ secrets.CODECOV_TOKEN }}
           files: ./coverage.xml
           flags: unittests
           name: codecov-umbrella
           fail_ci_if_error: true
           verbose: true